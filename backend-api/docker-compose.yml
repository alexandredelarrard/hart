services:
    back_app:
        container_name: backend_api
        build: 
            context: ./app
            dockerfile: dockerfile
        expose:
            - 5000
        command: gunicorn --bind 0.0.0.0:5000 --workers 4 --threads 4 --timeout 120 app:app
        volumes: 
            - ./app:/app
            - db-schema:/app/src/schemas
        environment:
            - FLASK_ENV=flask_worker
        env_file:
            - ../global-schemas/.env
        restart: always
        networks:
            - shared_net
    nginx:
        image: nginx:latest
        container_name: back_nginx
        ports:    
            - 2000:2000
        volumes:
            - ./nginx.conf:/etc/nginx/conf.d/default.conf
        restart: always
        depends_on: 
            - back_app
        networks:
            - shared_net
    celery:
        build:
            context: ./celery
            dockerfile: dockerfile
        # user: celeryuser
        container_name: back_celery
        volumes:
            - ./app:/app
            - D:/data/models:/data/models
            - D:/data/default:/data/default
        command: 'celery -A src.backend.tasks worker --pool=solo --loglevel=info --concurrency=1'
        env_file:
            - ./.env
        environment:
            - FLASK_ENV=celery_worker
        deploy:
            resources:
                reservations:
                    devices:
                        - driver: nvidia
                          count: 1
                          capabilities: [gpu]
        networks:
            - shared_net
        
networks: 
  shared_net:
    external: true

volumes:
    db-schema:
        driver: local
        driver_opts:
            type: "none"
            device: "../global-schemas/schemas"
            o: "bind"